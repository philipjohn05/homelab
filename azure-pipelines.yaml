# azure-pipelines.yml
# Optimized for homelab GitOps

trigger:
  branches:
    include:
      - main
  paths:
    include:
      - apps/**
      - docker/**
    exclude:
      - "**/*.md"
      - docs/**

pr:
  branches:
    include:
      - main
  paths:
    include:
      - apps/**
      - docker/**

pool:
  name: homelab-pool

stages:
  - stage: Validate
    displayName: "Validate Changes"
    jobs:
      - job: ValidateYAML
        displayName: "Validate Kubernetes YAML"
        steps:
          - script: |
              echo "Validating YAML files..."
              for file in $(find apps/ -name "*.yaml" -type f); do
                kubectl apply --dry-run=client -f "$file"
              done
            displayName: "Dry-run Validation"

  - stage: Test
    displayName: "Run Tests"
    dependsOn: Validate
    jobs:
      - job: TestAgent
        steps:
          - script: |
              docker version
              kubectl cluster-info
            displayName: "Verify Agent Capabilities"

  - stage: Deploy
    displayName: "Deploy to Cluster"
    dependsOn: Test
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
    jobs:
      - job: DeployApps
        steps:
          - script: |
              echo "Deploying changed applications..."
              # FluxCD will handle the actual deployment
              # This just validates the sync
              flux reconcile kustomization apps --with-source
            displayName: "Trigger FluxCD Sync"
